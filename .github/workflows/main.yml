on:
  push:
  schedule:
    - cron: "0 3 * * *"

jobs:
  get-radarr-version:
    runs-on: ubuntu-22.04
    outputs:
      radarr-version: ${{ steps.radarr-version-step.outputs.LATEST_RADARR_VERSION }}
      should-build: ${{ steps.should-build-step.outputs.SHOULD_BUILD }}
    steps:
      - run: >-
          echo LATEST_RADARR_VERSION=$(
          git -c 'versionsort.suffix=-' ls-remote --tags --sort='v:refname' https://github.com/Radarr/Radarr.git
          | tail -n1
          | sed -e 's/.*\///; s/\^{}//' -e 's/^v//'
          )
          | tee -a "$GITHUB_ENV" "$GITHUB_OUTPUT"
        id: radarr-version-step
      - run: >-
          docker manifest inspect "docker.io/guillaumedsde/radarr-distroless:${LATEST_RADARR_VERSION}" 
          || echo SHOULD_BUILD=1 >> "$GITHUB_OUTPUT"
        id: should-build-step

  docker:
    needs: get-radarr-version
    if: ${{ needs.get-radarr-version.outputs.should-build == '1' }}
    uses: guillaumedsde/qbittorrent-distroless/.github/workflows/docker.yml@master
    with:
      software-version: ${{ needs.get-radarr-version.outputs.radarr-version }}
      platforms: |
        linux/amd64
        linux/arm64
    secrets: inherit
